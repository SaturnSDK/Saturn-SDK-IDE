#!/bin/sh

if [ "x$MSYSTEM" != "x" ] ; then
  EXEEXT=".exe"
  LIBEXT="dll"
else
  EXEEXT=""
  LIBEXT="so"
fi

echo Creating output directory tree

mkdir -p output/share/codeblocks_con/plugins
mkdir -p output/share/codeblocks_con/scripts
mkdir -p devel/share/codeblocks_con/plugins
mkdir -p devel/share/codeblocks_con/scripts

ZIPCMD="zip"
RESDIR="devel/share/codeblocks_con"
echo Compressing core UI resources
echo Compressing plugins UI resources
${ZIPCMD} -jqu9 ${RESDIR}/compiler.zip plugins/compilergcc/resources/manifest.xml > /dev/null

echo Copying files
# Create an exclude pattern file
echo .svn > excludes.txt
echo Makefile >> excludes.txt
echo Makefile.am >> excludes.txt
echo Makefile.in >> excludes.txt
cp -f ${RESDIR}/*.zip output/share/codeblocks_con > /dev/null
cp -f scripts/*.script ${RESDIR}/scripts > /dev/null
cp -f scripts/*.script output/share/codeblocks_con/scripts > /dev/null
cp -f devel/codeblocks_con${EXEEXT} output > /dev/null
cp -f devel/*.${LIBEXT} output > /dev/null
cp -f ${RESDIR}/plugins/*.${LIBEXT} output/share/codeblocks_con/plugins > /dev/null
# Now remove the exclude pattern file
rm excludes.txt

echo Stripping debug info from output tree
strip output/codeblocks_con${EXEEXT}
strip output/*.${LIBEXT}
strip output/share/codeblocks_con/plugins/*.${LIBEXT}

if [ "x$MSYSTEM" = "x" ] ; then
  echo Creating launch-scripts
  echo "#!/bin/sh" > output/run_con.sh
  echo 'APP_DIR=`dirname "$0"`' >> output/run_con.sh
  echo 'APP_DIR=`( cd "$APP_DIR" && pwd )`' >> output/run_con.sh
  echo "export LD_LIBRARY_PATH=\$APP_DIR:\$LD_LIBRARY_PATH" >> output/run_con.sh
  echo "\$APP_DIR/codeblocks_con \$@" >> output/run_con.sh
  chmod +x output/run_con.sh
  echo "#!/bin/sh" > devel/run_con.sh
  echo 'APP_DIR=`dirname "$0"`' >> devel/run_con.sh
  echo 'APP_DIR=`( cd "$APP_DIR" && pwd )`' >> devel/run_con.sh
  echo "export LD_LIBRARY_PATH=\$APP_DIR:\$LD_LIBRARY_PATH" >> devel/run_con.sh
  echo "\$APP_DIR/codeblocks_con \$@" >> devel/run_con.sh
  chmod +x devel/run_con.sh
fi

ZIPCMD=
RESDIR=
